chart:
  appVersion: 0.1.0
  version: 0.1.0
suite: Deployment template
release:
  name: athens-proxy-unittest
  namespace: testing
templates:
- templates/configMapDownloadMode.yaml
- templates/configMapGitConfig.yaml
- templates/deployment.yaml
- templates/secretNetRC.yaml
- templates/secretSSH.yaml
tests:
- it: Rendering default without mounted netrc secret
  asserts:
    - notExists:
        path: spec.template.metadata.annotations.checksum/secret-athens-proxy-unittest-netrc
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: netrc
          mountPath: /root
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.volumes
        content:
          name: secrets
          projected:
            sources:
            - secret:
                items:
                - key: .netrc
                  path: .netrc
                  mode: 0600
                name: athens-proxy-unittest-netrc
      template: templates/deployment.yaml

- it: Rendering default with mounted netrc secret
  set:
    config.netrc.enabled: true
    persistence.enabled: true
  asserts:
    - exists:
        path: spec.template.metadata.annotations.checksum/secret-athens-proxy-unittest-netrc
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.netrc
          subPath: .netrc
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: secrets
          projected:
            sources:
            - secret:
                items:
                - key: .netrc
                  path: .netrc
                  mode: 0600
                name: athens-proxy-unittest-netrc
      template: templates/deployment.yaml

- it: Rendering with custom netrc secret
  set:
    config.netrc.enabled: true
    config.netrc.existingSecret.enabled: true
    config.netrc.existingSecret.secretName: "my-custom-secret"
    config.netrc.existingSecret.netrcKey: "my-netrc-key"
    persistence.enabled: true
  asserts:
    - notExists:
        path: spec.template.metadata.annotations.checksum/secret-athens-proxy-unittest-netc
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.netrc
          subPath: .netrc
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: secrets
          projected:
            sources:
            - secret:
                items:
                - key: my-netrc-key
                  path: .netrc
                  mode: 0600
                name: my-custom-secret
      template: templates/deployment.yaml