chart:
  appVersion: 0.1.0
  version: 0.1.0
suite: Deployment template
release:
  name: athens-proxy-unittest
  namespace: testing
templates:
- templates/deployment.yaml
tests:
- it: Test persistent volume claim
  set:
    persistence.enabled: true
  asserts:
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: ATHENS_STORAGE_TYPE
          value: disk
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: ATHENS_DISK_STORAGE_ROOT
          value: /var/www/athens-proxy/data
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: data
          mountPath: /var/www/athens-proxy/data
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: data
          persistentVolumeClaim:
            claimName: athens-proxy-unittest-data
      template: templates/deployment.yaml

- it: Test existing persistent volume claim
  set:
    config.netrc.enabled: true
    persistence.enabled: true
    persistence.data.mountPath: "/mnt/go-proxy/data"
    persistence.data.existingPersistentVolumeClaim.enabled: true
    persistence.data.existingPersistentVolumeClaim.persistentVolumeClaimName: "my-special-pvc"
  asserts:
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: ATHENS_STORAGE_TYPE
          value: disk
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: ATHENS_DISK_STORAGE_ROOT
          value: /mnt/go-proxy/data
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: data
          mountPath: /mnt/go-proxy/data
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: data
          persistentVolumeClaim:
            claimName: my-special-pvc
      template: templates/deployment.yaml