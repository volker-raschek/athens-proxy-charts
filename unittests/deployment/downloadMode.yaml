chart:
  appVersion: 0.1.0
  version: 0.1.0
suite: Deployment template
release:
  name: athens-proxy-unittest
  namespace: testing
templates:
- templates/configMapDownloadMode.yaml
- templates/configMapGitConfig.yaml
- templates/deployment.yaml
- templates/secretNetRC.yaml
- templates/secretSSH.yaml
tests:
- it: Rendering default without mounted download mode config map
  asserts:
    - notExists:
        path: spec.template.metadata.annotations.checksum/config-map-athens-proxy-unittest-download-mode-file
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].env
        content:
          name: ATHENS_DOWNLOAD_MODE
          value: file:/etc/athens/config/download-mode.d/download-mode
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: download-mode
          mountPath: /etc/athens/config/download-mode.d
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.volumes
        content:
          name: download-mode
          configMap:
            name: athens-proxy-unittest-download-mode-file
      template: templates/deployment.yaml

- it: Rendering default with mounted gitconfig configMap
  set:
    config.downloadMode.enabled: true
    persistence.enabled: true
  asserts:
    - exists:
        path: spec.template.metadata.annotations.checksum/config-map-athens-proxy-unittest-download-mode-file
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: ATHENS_DOWNLOAD_MODE
          value: file:/etc/athens/config/download-mode.d/download-mode
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: download-mode
          mountPath: /etc/athens/config/download-mode.d
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: download-mode
          configMap:
            items:
              - key: downloadMode
                mode: 0644
                path: download-mode
            name: athens-proxy-unittest-download-mode-file
      template: templates/deployment.yaml

- it: Rendering with custom download mode configMap
  set:
    config.downloadMode.enabled: true
    config.downloadMode.existingConfigMap.enabled: true
    config.downloadMode.existingConfigMap.configMapName: "my-custom-configmap"
    config.downloadMode.existingConfigMap.downloadModeKey: "my-custom-download-mode-filename-key"
    persistence.enabled: true
  asserts:
    - notExists:
        path: spec.template.metadata.annotations.checksum/config-map-athens-proxy-unittest-download-mode-file
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].env
        content:
          name: ATHENS_DOWNLOAD_MODE
          value: file:/etc/athens/config/download-mode.d/download-mode
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: download-mode
          mountPath: /etc/athens/config/download-mode.d
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: download-mode
          configMap:
            items:
            - key: "my-custom-download-mode-filename-key"
              path: "download-mode"
              mode: 0644
            name: my-custom-configmap
      template: templates/deployment.yaml