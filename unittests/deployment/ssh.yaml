chart:
  appVersion: 0.1.0
  version: 0.1.0
suite: Deployment template
release:
  name: athens-proxy-unittest
  namespace: testing
templates:
- templates/configMapDownloadMode.yaml
- templates/configMapGitConfig.yaml
- templates/deployment.yaml
- templates/secretNetRC.yaml
- templates/secretSSH.yaml
tests:
- it: Rendering default without mounted ssh secret
  asserts:
    - notExists:
        path: spec.template.metadata.annotations.checksum/secret-athens-proxy-unittest-ssh
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/config
          subPath: config
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_ed25519
          subPath: id_ed25519
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_ed25519.pub
          subPath: id_ed25519.pub
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_rsa
          subPath: id_rsa
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_rsa.pub
          subPath: id_rsa.pub
      template: templates/deployment.yaml
    - notContains:
        path: spec.template.spec.volumes
        content:
          name: secrets
          projected:
            sources:
            - secret:
                items:
                - key: config
                  path: config
                  mode: 0644
                - key: id_ed25519
                  path: id_ed25519
                  mode: 0600
                - key: id_ed25519.pub
                  path: id_ed25519.pub
                  mode: 0644
                - key: id_rsa
                  path: id_rsa
                  mode: 0600
                - key: id_rsa.pub
                  path: id_rsa.pub
                  mode: 0644
                name: athens-proxy-unittest-ssh
      template: templates/deployment.yaml

- it: Rendering default with mounted ssh config
  set:
    config.ssh.enabled: true
    persistence.enabled: true
  asserts:
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/config
          subPath: config
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: secrets
          projected:
            sources:
            - secret:
                items:
                - key: config
                  path: config
                  mode: 0600
                name: athens-proxy-unittest-ssh
      template: templates/deployment.yaml

- it: Rendering default with mounted ssh keys
  set:
    config.ssh.enabled: true
    config.ssh.secret.id_ed25519: foo
    config.ssh.secret.id_ed25519_pub: bar
    config.ssh.secret.id_rsa: foo
    config.ssh.secret.id_rsa_pub: bar
    persistence.enabled: true
  asserts:
    - exists:
        path: spec.template.metadata.annotations.checksum/secret-athens-proxy-unittest-ssh
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/config
          subPath: config
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_ed25519
          subPath: id_ed25519
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_ed25519.pub
          subPath: id_ed25519.pub
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_rsa
          subPath: id_rsa
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_rsa.pub
          subPath: id_rsa.pub
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: secrets
          projected:
            sources:
            - secret:
                items:
                - key: config
                  path: config
                  mode: 0600
                - key: id_ed25519
                  path: id_ed25519
                  mode: 0600
                - key: id_ed25519.pub
                  path: id_ed25519.pub
                  mode: 0644
                - key: id_rsa
                  path: id_rsa
                  mode: 0600
                - key: id_rsa.pub
                  path: id_rsa.pub
                  mode: 0644
                name: athens-proxy-unittest-ssh
      template: templates/deployment.yaml

- it: Rendering with custom ssh secret
  set:
    config.ssh.enabled: true
    config.ssh.existingSecret.enabled: true
    config.ssh.existingSecret.secretName: "my-custom-secret"
    config.ssh.existingSecret.configKey : "my-config-key"
    config.ssh.existingSecret.id_ed25519Key : "my-private-ed25519-key"
    config.ssh.existingSecret.id_ed25519PubKey : "my-public-ed25519-key"
    config.ssh.existingSecret.id_rsaKey : "my-private-rsa-key"
    config.ssh.existingSecret.id_rsaPubKey : "my-public-rsa-key"
    persistence.enabled: true
  asserts:
    - notExists:
        path: spec.template.metadata.annotations.checksum/secret-athens-proxy-unittest-ssh
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/config
          subPath: config
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_ed25519
          subPath: id_ed25519
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_ed25519.pub
          subPath: id_ed25519.pub
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_rsa
          subPath: id_rsa
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.containers[0].volumeMounts
        content:
          name: secrets
          mountPath: /root/.ssh/id_rsa.pub
          subPath: id_rsa.pub
      template: templates/deployment.yaml
    - contains:
        path: spec.template.spec.volumes
        content:
          name: secrets
          projected:
            sources:
            - secret:
                items:
                - key: my-config-key
                  path: config
                  mode: 0600
                - key: my-private-ed25519-key
                  path: id_ed25519
                  mode: 0600
                - key: my-public-ed25519-key
                  path: id_ed25519.pub
                  mode: 0644
                - key: my-private-rsa-key
                  path: id_rsa
                  mode: 0600
                - key: my-public-rsa-key
                  path: id_rsa.pub
                  mode: 0644
                name: my-custom-secret
      template: templates/deployment.yaml