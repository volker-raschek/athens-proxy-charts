chart:
  appVersion: 0.1.0
  version: 0.1.0
suite: Secret ssh template
release:
  name: athens-proxy-unittest
  namespace: testing
templates:
- templates/secretSSH.yaml
tests:
- it: Skip rending by default.
  asserts:
  - hasDocuments:
      count: 0

- it: Skip rendering by using existing secret.
  set:
    config.ssh.enabled: true
    config.ssh.existingSecret.enabled: true
  asserts:
  - hasDocuments:
      count: 0

- it: Rendering ssh secret with default values.
  set:
    config.ssh.enabled: true
  asserts:
  - hasDocuments:
      count: 1
  - containsDocument:
      apiVersion: v1
      kind: Secret
      name: athens-proxy-unittest-ssh
      namespace: testing
  - notExists:
      path: metadata.annotations
  - equal:
      path: metadata.labels
      value:
        app.kubernetes.io/instance: athens-proxy-unittest
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: athens-proxy
        app.kubernetes.io/version: 0.1.0
        helm.sh/chart: athens-proxy-0.1.0
  - equal:
      path: stringData.config
      value: |
        # Host *
        #   IdentityFile ~/.ssh/id_ed25519
        #   IdentityFile ~/.ssh/id_rsa
  - notExists:
      path: stringData.id_ed25519
  - notExists:
      path: stringData["id_ed25519.pub"]
  - notExists:
      path: stringData.id_rsa
  - notExists:
      path: stringData["id_rsa.pub"]

- it: Rendering ssh secret with custom values.
  set:
    config.ssh.enabled: true
    config.ssh.secret.config: |
      Host *
        IdentityFile ~/.ssh/id_ed25519
        IdentityFile ~/.ssh/id_rsa
    config.ssh.secret.id_ed25519: |
      my-private-25519-key
    config.ssh.secret.id_ed25519_pub: |
      my-public-25519-key
    config.ssh.secret.id_rsa: |
      my-private-rsa-key
    config.ssh.secret.id_rsa_pub: |
      my-public-rsa-key

  asserts:
  - equal:
      path: stringData.config
      value: |
        Host *
          IdentityFile ~/.ssh/id_ed25519
          IdentityFile ~/.ssh/id_rsa
  - equal:
      path: stringData.id_ed25519
      value: |
        my-private-25519-key
  - equal:
      path: stringData["id_ed25519.pub"]
      value: |
        my-public-25519-key
  - equal:
      path: stringData.id_rsa
      value: |
        my-private-rsa-key
  - equal:
      path: stringData["id_rsa.pub"]
      value: |
        my-public-rsa-key

- it: Rendering custom annotations and labels.
  set:
    config.ssh.enabled: true
    config.ssh.secret.annotations:
      foo: bar
      bar: foo
    config.ssh.secret.labels:
      foo: bar
      bar: foo
  asserts:
  - equal:
      path: metadata.annotations
      value:
        foo: bar
        bar: foo
  - isSubset:
      path: metadata.labels
      content:
        foo: bar
        bar: foo